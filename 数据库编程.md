# ———————————数据库编程—————————— #

<p id="t"></p>

## :book:集合 ##

:arrow_double_down:<a href="#a1">连接到数据库</a>

:arrow_double_down:<a href="#a2">使用JDBC语句</a>

:arrow_double_down:<a href="#a3">数据库管理</a>

:arrow_double_down:<a href="#a4">执行查询语句</a>

<p id="a1"><p>
  
### :custard:连接到数据库 ###

:arrow_double_up:<a href="#t">返回目录</a>

在Java程序中，我们可以在代码中打开一个数据库连接，在这之前需要做一些准备工作，第一步下载驱动：

[下载地址](http://static.runoob.com/download/mysql-connector-java-5.1.39-bin.jar)

在编译器引入包，并注册驱动程序，把驱动包存放于环境中，如果是java程序，存放在JDK中的jre/lib/ext中，如果是网站项目，则放在项目的WEB-INF/lib目录下。

连接mysql：

```
    public  static void main(String arg[])
    {
        String url = "jdbc:mysql://127.0.0.1:3306/sgz?useSSL=true";
        String user = "root";
        String pw = "111111";
        try {
            Class.forName("com.mysql.jdbc.Driver");                  //注册驱动
            Connection conn = DriverManager.getConnection(url,user,pw); //连接

            if(conn.isClosed()){
                  System.out.println("没打开");
            }
            else{
                  System.out.println("打开成功");
                }
            }
        }
        catch (Exception e){
            e.printStackTrace();
            System.out.println(e.getMessage());
        }
    }
```

连接语句` Connection conn = DriverManager.getConnection(url,user,pw)`可以打开mysql用户的数据库，该方法需要提供三个参数，

**String url**： jdbc:mysql:`连接地址`/`数据库名称`?useSSL=true   ,其中jdbc:mysql:是必须按照这样写的，后面依次加上地址/数据库名，最后的一个参数是获得服务器身份验证的许可，要不然会出现一个警告。

**String user**： Mysql的用户名称，我这里使用的root管理员用户，实际运用不推荐这样，可使用一个用户来链接

**String password**： 链接数据库的密码。

参数，数据库正确，就可以连上数据库。

<p id="a2"><p>
  
### :custard:使用JDBC语句 ###

:arrow_double_up:<a href="#t">返回目录</a>

#### :beer:执行SQL语句 ####

在执行SQL语句之前，首先需要创建一个Statement对象。要创建这个对象又需要获得已经连接的数据库。如下：

```java
Statement stat = conn.createStatement();
```

这样就有了一个stat的命令对象。对于SQL命令的执行有几种不同的方法。如下：

**executeUpdate(String command)** : 该方法将执行sql语句，返回受SQL语句影响的行数，或者对不返回行数的语句返回0。

**execute(String command)** : 该方法将执行sql语句，如果产生结果集，返回true，否者是false。

**executeQuery(String command)** : 执行SQL语句，并返回一个可用于查看的结果的ResultSet对象。常用于查看表数据

**executeLargeUpdate(String command)** ：执行SQL语句，除了基本的表数据操作外，还可以创建表，删除表，返回受影响的的行数。


`executeUpdate方法`一般与操作影响行数的操作一起使用，如下是对表插入数据的语法，插入操作会影响行数。我们通过该方法来检验是否插入成功：

```java
    public  static void main(String arg[])
    {
        String url = "jdbc:mysql://127.0.0.1:3306/sgz?useSSL=true";
        String user = "root";
        String pw = "chuan.868";
        try {
            Class.forName("com.mysql.jdbc.Driver");
            Connection conn = DriverManager.getConnection(url,user,pw);

            if(conn.isClosed()){
                System.out.println("没打开");
            }
            else{
                Statement stat = conn.createStatement();
                int i =  stat.executeUpdate("insert  into WJ values ('陆逊','吴',83,84,89,94)");
                if(i!=0){
                    System.out.println("操作成功！"+i+"行受影响");
                }
                else{
                    System.out.println("操作未成功");
                }
            }
        }
        catch (Exception e){
            e.printStackTrace();
            System.out.println(e.getMessage());
        }
    }
```

最后控制器显示：

`操作成功！1行受影响`

代表我们的操作成功，可在数据表中查看到相应数据.如果出现插入表数据中文，可以在链接数据库的时候user改为：

`"jdbc:mysql://127.0.0.1:3306/sgz?useSSL=true&useUnicode=true&characterEncoding=UTF-8";`

`execute方法`只是查看是否有结果产生，比如常见的查询操作。还有返回结果，可以使用该方法来判断查询操作是否成功：

```java
    public  static void main(String arg[])
    {
        String url = "jdbc:mysql://127.0.0.1:3306/sgz?useSSL=true";
        String user = "root";
        String pw = "chuan.868";
        try {
            Class.forName("com.mysql.jdbc.Driver");
            Connection conn = DriverManager.getConnection(url,user,pw);
            if(conn.isClosed()){
                System.out.println("没打开");
            }
            else{
                Statement stat = conn.createStatement();
                Boolean result =  stat.execute("SELECT  * from  WJ");
                if(result){
                    System.out.println("操作成功并产生结果集");
                }
                else{
                    System.out.println("操作未成功");
                }
            }
        }
        catch (Exception e){
            e.printStackTrace();
            System.out.println(e.getMessage());
        }
    }
}
```

该方法用于查看返回数据的方法主要是`getResultSet()`和`getUpdateCount()`,前者是返回结果集，后者只是返回第一个执行结果所影响的行数，如果操作没有改变数据表返回-1.

`getResultSe`方法用于返回上一次查询的结果集，如

```java
    public  static void main(String arg[])
    {
        String url = "jdbc:mysql://127.0.0.1:3306/sgz?useSSL=true&useUnicode=true&characterEncoding=UTF-8";
        String user = "root";
        String pw = "chuan.868";
        try {
            Class.forName("com.mysql.jdbc.Driver");
            Connection conn = DriverManager.getConnection(url,user,pw);
            if(conn.isClosed()){
                System.out.println("没打开");
            }
            else{
                Statement stat = conn.createStatement();
                Boolean result =  stat.execute("SELECT  * from  WJ ");
                if(result){
                    System.out.println("操作成功并产生结果集");
                    ResultSet re = stat.getResultSet();

                while (re.next()){
                    String s1 = re.getString(1);
                    String s2 = re.getString(2);
                    int s3 = re.getInt(3);
                    int s4 = re.getInt(4);
                    int s5 = re.getInt(5);
                    int s6 = re.getInt(6);
                    System.out.println("Name:"+s1+ " Power:"+s2+" Number: "+s3+"-"+s4+"-"+s5+"-"+s6);
                   }
                }
                else{
                    System.out.println("操作未成功");
                }
            }
        }
        catch (Exception e){
            e.printStackTrace();
            System.out.println(e.getMessage());
        }
    }
}
```

如果只想查看数据，使用上面的这种方法会比较复杂。可以直接使用executeQuery()方法返回一个结果集来查看结果：

```java
    public  static void main(String arg[])
    {
        String url = "jdbc:mysql://127.0.0.1:3306/sgz?useSSL=true&useUnicode=true&characterEncoding=UTF-8";
        String user = "root";
        String pw = "chuan.868";
        try {
            Class.forName("com.mysql.jdbc.Driver");
            Connection conn = DriverManager.getConnection(url,user,pw);
            if(conn.isClosed()){
                System.out.println("没打开");
            }
            else{
                Statement stat = conn.createStatement();

                ResultSet re =  stat.executeQuery("SELECT  * from  WJ ");
                while (re.next()){ 
                    String s1 = re.getString(1);
                    String s2 = re.getString(2);
                    int s3 = re.getInt(3);
                    int s4 = re.getInt(4);
                    int s5 = re.getInt(5);
                    int s6 = re.getInt(6);
                    System.out.println("Name:"+s1+ " Power:"+s2+" Number: "+s3+"-"+s4+"-"+s5+"-"+s6);
                }
            }
        }
        catch (Exception e){
            e.printStackTrace();
            System.out.println(e.getMessage());
        }
    }
```

上面是常用的几种执行语句方法，下面就介绍在返回结果集中需要常用的操作的方法：

```java
boolean next()  : 结果集是否有下一行，如果是最后一行返回false

String/int  getString/Int(int index) : 返回index列的值，index从1开始

String/int  getString/Int(String lie) : 直接返回列名为lie的值

int findColumn(String lie) : 返回该列的序号。
```

我们从前面的例子就可以看到这几个方法的使用：

```java
ResultSet re =  stat.executeQuery("SELECT  * from  WJ ");
while (re.next()){             //是否有下一行
      String s1 = re.getString(1);        //获取第一列
      String s2 = re.getString(2);       //获取第二列
      int s3 = re.getInt(3);
      int s4 = re.getInt(4);
      int s5 = re.getInt(5);
      int s6 = re.getInt(6);
      System.out.println("Name:"+s1+ " Power:"+s2+" Number: "+s3+"-"+s4+"-"+s5+"-"+s6);
}
```

由于我是知道我的表列是什么类型，所以我使用了上面这种方法，还可以添加列名来获取指定列的值。

在最后要记得关闭数据库连接，使用close()方法关闭连接，isClosed()可以查看是否关闭。

***

<p id="a3"><p>
  
### :custard:数据库管理 ###

:arrow_double_up:<a href="#t">返回目录</a>

每个Connection都可以创建一个或者多个Statement对象，同一个Statement对象可以用于多个不相关的命令与查询。如果需要执行多个操作，且需要同时分析数据，那么就必须创建多个Statement对象。但实际上我们并不需要同时处理多个结果集，如果结果相互关联，我们可以使用组合查询。这样比使用java程序遍历多个结果方便的多。

使用完ResultSet，Statement，或者Connection对象后，应立即调用close()方法，这样他们不会长时间占用服务器的有限资源。这三个对象都具有close方法，使用完就可以调用。如果连接都是短时间，则无需考虑关闭结果集和语句。只需要将close语句放在带有资源的try中即可。以便连接对象不可能一直打开。

在sql中java还有处理异常机制。以下只是简单介绍这些方法：

```java
SQLExecption getNextException()  : 返回链接到该SQL异常的下一个异常，或者在链为返回null

Iterator<Throwable>  iterator() :获取迭代器，可以迭代链接的SQL异常和他们成因

String getSQLState() : 获取SQL状态，即标准化的错误代码。

SQLWarning getNextWarning() : 返回链接到该警告的下一个警告，或者到达末尾null

SQLWarning getWarnings() ： 返回未处理警告中的第一个。

```

***

<p id="a4"><p>
  
### :custard:执行查询语句 ###

:arrow_double_up:<a href="#t">返回目录</a>

#### :beer:预备语句 ####

在数据库查询等语句中，所给的SQL语句都是字符串事先写好的，比如如下：

```java
ResultSet re =  stat.executeQuery("SELECT  * from  WJ WHERE military > 80 and power = '蜀'");
```

这样条件就只能是 military > 80 and power = '蜀'，如果修改条件又要重新修改语句，那么有没有变量来代替这两个条件的呢？答案是肯定的，在sql字符变量中我们可以使用“？”来代替条件变量：

```java
PreparedStatement stat = conn.prepareStatement("SELECT  * from  WJ WHERE military > ? and power = ?");
 stat.setInt(1,70);
stat.setString(2,"蜀");
ResultSet re =  stat.executeQuery();
```

上面代码中第一步做的就是使用预备语句（PreparedStatement）来创建一个statement对象，其中？代表变量位置。

`setString()`方法用于修改变量数据，第一个参数为？的位置，从第一个开始，第二个参数为修改的值，类型必须为String。如果想修改数值型使用`setInt()`方法，与前者一样的用法。

#### :beer:读写LOB ####

除了基本的数据外，数据库还可以存储图片与其他数据，在SQL中，二进制大对象称为BLOB，字符串大对象称为CLOB。






